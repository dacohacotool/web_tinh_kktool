<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bán Key</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #eef3f7;
      padding: 40px;
      margin: 0;
    }
    .container {
      max-width: 440px;
      background: white;
      padding: 30px;
      margin: auto;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: bold;
    }
    select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      margin-top: 6px;
      font-size: 15px;
    }
    .switch-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 20px;
    }
    .switch-label {
      font-weight: bold;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 26px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #28a745;
    }
    input:checked + .slider:before {
      transform: translateX(24px);
    }
    .price {
      font-size: 22px;
      font-weight: bold;
      color: #222;
      text-align: center;
      margin-top: 30px;
    }
    button {
      width: 100%;
      padding: 14px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      margin-top: 20px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Mua Key Kích Hoạt</h2>

    <label for="keyType">Loại key:</label>
    <select id="keyType">
      <option value="kktool">KKtool & KKgen2</option>
      <option value="haco">Haco</option>
    </select>

    <label for="days">Số ngày sử dụng:</label>
    <select id="days">
      <option value="1">1 ngày</option>
      <option value="7">7 ngày</option>
      <option value="30">30 ngày</option>
    </select>

    <label for="deviceSelect">Số thiết bị:</label>
    <select id="deviceSelect"></select>

    <div class="switch-container" id="activeContainer">
      <span class="switch-label">Kích hoạt lần đầu:</span>
      <label class="switch">
        <input type="checkbox" id="firstActive">
        <span class="slider"></span>
      </label>
    </div>

    <div class="price" id="price">Giá: 0 VNĐ</div>

    <button onclick="taoHoaDon('kktool', 7, 5, true, 15000)">Tạo hóa đơn</button>

  </div>

  <script>
  async function fetchServerURL() {
    try {
      const response = await fetch('https://raw.githubusercontent.com/dacohacotool/host_kk/main/url_serverkey.txt');
      if (!response.ok) {
        throw new Error('Không thể tải URL máy chủ');
      }
      const text = await response.text();
      return text.trim();
    } catch (error) {
      console.error('Lỗi khi tải URL máy chủ:', error);
      return null;
    }
  }

  async function taoHoaDon(type, days, devices, isFirst, price) {
    const serverURL = await fetchServerURL();
    if (!serverURL) {
      alert('Không thể lấy URL máy chủ. Vui lòng thử lại sau.');
      return;
    }

    const url = `${serverURL}/tao_hoa_don?type=${encodeURIComponent(type)}&days=${encodeURIComponent(days)}&devices=${encodeURIComponent(devices)}&first=${isFirst ? 1 : 0}&price=${encodeURIComponent(price)}`;
    window.location.href = url;
  }

    const keyTypeSelect = document.getElementById("keyType");
    const daysSelect = document.getElementById("days");
    const deviceSelect = document.getElementById("deviceSelect");
    const firstActiveCheckbox = document.getElementById("firstActive");
    const activeContainer = document.getElementById("activeContainer");
    const priceDisplay = document.getElementById("price");

    const priceTable = {
      kktool: {
        1: { "unlimited": 10000, 1: 2000, 5: 5000 },
        7: { 1: 10000, 5: 15000, 10: 20000, "unlimited": 80000 },
        30: { 5: 30000, 10: 45000, 20: 60000, "unlimited": 120000 }
      },
      haco: {
        activeFee: 30000,
        1: { 1: 1000, 10: 5000, 20: 10000, 40: 15000, "unlimited": 20000 },
        7: { 2: 10000, 10: 30000, 20: 40000, 40: 60000, "unlimited": 70000 },
        30: { 5: 40000, 10: 60000, 20: 80000, 40: 100000, "unlimited": 140000 }
      }
    };

    function updateDeviceOptions() {
      const type = keyTypeSelect.value;
      const days = parseInt(daysSelect.value);
      const pricing = priceTable[type][days];

      deviceSelect.innerHTML = "";
      for (const device in pricing) {
        const option = document.createElement("option");
        option.value = device;
        option.textContent = device === "unlimited" ? "Không giới hạn" : `${device} máy`;
        deviceSelect.appendChild(option);
      }
    }

    function calcPrice() {
      const type = keyTypeSelect.value;
      const days = parseInt(daysSelect.value);
      const devices = deviceSelect.value;
      const isFirst = firstActiveCheckbox.checked;

      const pricing = priceTable[type][days];
      let price = pricing[devices] || 0;

      if (type === "haco" && isFirst) {
        price += priceTable.haco.activeFee;
      }

      priceDisplay.innerText = `Giá: ${price.toLocaleString()} VNĐ`;
      return { price, devices, type, days, isFirst };
    }

    function checkout() {
      const { price, devices, type, days, isFirst } = calcPrice();
      const url = `http://192.168.50.249:5551/tao_hoa_don?type=${type}&days=${days}&devices=${devices}&first=${isFirst ? 1 : 0}&price=${price}`;
      window.location.href = url;
    }

    keyTypeSelect.addEventListener("change", () => {
      activeContainer.style.display = keyTypeSelect.value === "kktool" ? "none" : "flex";
      updateDeviceOptions();
      calcPrice();
    });

    daysSelect.addEventListener("change", () => {
      updateDeviceOptions();
      calcPrice();
    });

    deviceSelect.addEventListener("change", calcPrice);
    firstActiveCheckbox.addEventListener("change", calcPrice);

    // Init
    activeContainer.style.display = "none";
    updateDeviceOptions();
    calcPrice();
  </script>
</body>
</html>
